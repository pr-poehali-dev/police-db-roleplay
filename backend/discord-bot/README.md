# Discord Bot для Полицейской БД

Discord бот для управления персонажами и синхронизации ролей пользователей.

## Возможности

### Для всех пользователей:
- `/создать_персонажа` - Создать своего гражданского персонажа
- `/мой_персонаж` - Посмотреть информацию о своём персонаже

### Для администраторов Discord:
- `/синхронизация` - Синхронизировать роль пользователя с базой данных

## Настройка

### Шаг 1: Создайте Discord приложение

1. Зайдите на https://discord.com/developers/applications
2. Нажмите **New Application**
3. Введите имя бота (например, "Полицейская БД")
4. Перейдите в раздел **Bot**
5. Нажмите **Reset Token** и скопируйте токен
6. Включите следующие **Privileged Gateway Intents**:
   - SERVER MEMBERS INTENT
   - MESSAGE CONTENT INTENT

### Шаг 2: Добавьте бота на сервер

1. Перейдите в раздел **OAuth2 → URL Generator**
2. Выберите scope: `bot` и `applications.commands`
3. Выберите Bot Permissions:
   - Send Messages
   - Use Slash Commands
   - Read Message History
4. Скопируйте сгенерированную ссылку и откройте её
5. Добавьте бота на ваш сервер

### Шаг 3: Настройте секреты в poehali.dev

Добавьте следующие секреты в проекте:

1. **DISCORD_BOT_TOKEN** - токен бота из Developer Portal
2. **DISCORD_GUILD_ID** - ID вашего Discord сервера
   - Включите режим разработчика: Настройки → Расширенные → Режим разработчика
   - ПКМ на сервер → Копировать ID сервера
3. **DISCORD_APP_ID** - Application ID из Developer Portal
   - Находится в разделе General Information

### Шаг 4: Разверните функцию

После создания функции в backend/discord-bot/, выполните:
```bash
# Это развернёт функцию и создаст публичный URL
```

### Шаг 5: Настройте Interactions Endpoint URL

1. В Discord Developer Portal → General Information
2. В поле **INTERACTIONS ENDPOINT URL** укажите:
   ```
   https://ваш-url-из-func2url.json/discord-bot
   ```
3. Discord отправит тестовый запрос для верификации
4. Если всё настроено правильно, URL будет сохранён

### Шаг 6: Зарегистрируйте команды

Запустите скрипт регистрации команд:
```bash
python backend/discord-bot/register_commands.py
```

## Использование

### Создание персонажа

```
/создать_персонажа имя:Иван фамилия:Петров дата_рождения:1995-05-15
```

- Каждый пользователь Discord может создать только одного персонажа
- Персонаж автоматически привязывается к вашему Discord аккаунту
- ID-карта генерируется автоматически

### Просмотр персонажа

```
/мой_персонаж
```

Показывает:
- ФИО и дату рождения
- ID-карту
- Статус (розыск, если есть)
- Количество преступлений и штрафов

### Синхронизация ролей (только администраторы)

```
/синхронизация пользователь:@Username роль:moderator
```

Доступные роли:
- `user` - Обычный пользователь (только просмотр)
- `moderator` - Модератор (может добавлять записи)
- `admin` - Администратор (полный доступ)

## Интеграция с БД

Бот автоматически:
- Добавляет поля `discord_user_id` и `discord_username` к персонажам
- Связывает Discord аккаунты с пользователями системы
- Обеспечивает уникальность: один Discord аккаунт = один персонаж

## Безопасность

- Используется Simple Query Protocol для PostgreSQL
- Все входные данные экранируются через параметризованные запросы
- Проверка прав доступа для административных команд
- Discord верификация через PING/PONG handshake

## Troubleshooting

### "Не удалось сохранить Interactions Endpoint URL"
- Убедитесь, что функция развёрнута и доступна
- Проверьте, что URL возвращает корректный ответ на PING (type: 1)

### "У вас нет персонажа"
- Сначала создайте персонажа через `/создать_персонажа`

### "Недостаточно прав"
- Команда `/синхронизация` доступна только администраторам Discord сервера

### "База данных недоступна"
- Убедитесь, что секрет `DATABASE_URL` настроен в проекте
- Проверьте подключение к БД
